# ะะฐะปะฐัััะฒะฐะฝะฝั Cloudflare KV ะดะปั ััะพะฝัะตะฝะดั

ะฆั ัะฝััััะบััั ะพะฟะธััั, ัะบ ะฝะฐะปะฐัััะฒะฐัะธ ััะพะฝัะตะฝะด ะดะปั ัะพะฑะพัะธ ะท Cloudflare KV ะฝะฐ Cloudflare Pages.

## ๐ ะะตัะตะดัะผะพะฒะธ

1. ะคัะพะฝัะตะฝะด ัะพะทะณะพัะฝััะธะน ะฝะฐ **Cloudflare Pages**
2. Cloudflare KV Namespace ะฒะถะต ััะฒะพัะตะฝะพ (ะดะธะฒััััั `agent/CLOUDFLARE_KV.md`)
3. ะฃ ะฒะฐั ั ะดะพัััะฟ ะดะพ Cloudflare Dashboard

## ๐ง ะะพะบัะพะบะพะฒะฐ ัะฝััััะบััั

### ะัะพะบ 1: ะะพะดะฐัะธ Environment Variables ะฝะฐ Cloudflare Pages

1. ะะตัะตะนะดััั ะฒ **Cloudflare Dashboard** โ **Workers & Pages** โ ะฒะฐั ะฟัะพะตะบั (ััะพะฝัะตะฝะด)
2. ะะธะฑะตัััั **Settings** โ **Environment Variables**
3. ะะพะดะฐะนัะต ะฝะฐัััะฟะฝั ะทะผัะฝะฝั (ะฑะตะท ะฟัะตััะบัั `NEXT_PUBLIC_`):

#### Production Environment:
- `CLOUDFLARE_ACCOUNT_ID` - ะฒะฐั Account ID ะท Cloudflare
- `CLOUDFLARE_API_TOKEN` - API Token ะท ะฟัะฐะฒะฐะผะธ ะฝะฐ KV (ัะต ัะฐะผะต, ัะพ ะฒ ะฐะณะตะฝัั)
- `CLOUDFLARE_KV_NAMESPACE_ID` - ID KV Namespace

#### Preview Environments (ะพะฟััะพะฝะฐะปัะฝะพ):
ะะพะดะฐะนัะต ัั ัะฐะผั ะทะผัะฝะฝั ะดะปั preview environments, ัะบัะพ ะฟะพัััะฑะฝะพ ัะตัััะฒะฐัะธ ะฝะฐ staging.

### ะัะพะบ 2: ะะฐะปะฐัััะฒะฐัะธ ะทะผัะฝะฝั ะดะปั ะฑัะฐัะทะตัะฐ

ะฃ ัะฐะนะปั `frontend/.env.local` (ะดะปั ะปะพะบะฐะปัะฝะพั ัะพะทัะพะฑะบะธ) ะฐะฑะพ ะฒ Environment Variables ะฝะฐ Cloudflare Pages ะดะพะดะฐะนัะต:

```env
# ะะฐะทะพะฒะธะน URL API ะฐะณะตะฝัะฐ (ะฒะธะบะพัะธััะพะฒัััััั ัะบ fallback)
NEXT_PUBLIC_API_URL=http://localhost:3000

# ะะธะบะพัะธััะพะฒัะฒะฐัะธ ััะฝะตะปั ะดะปั ะพััะธะผะฐะฝะฝั URL ะท KV
NEXT_PUBLIC_USE_TUNNEL=true
```

**ะะฐะถะปะธะฒะพ:**
- ะะผัะฝะฝั `CLOUDFLARE_*` (ะฑะตะท `NEXT_PUBLIC_`) ะฒะธะบะพัะธััะพะฒัััััั ััะปัะบะธ ะฝะฐ ัะตัะฒะตัั (API routes)
- ะะผัะฝะฝั `NEXT_PUBLIC_*` ะดะพัััะฟะฝั ะฒ ะฑัะฐัะทะตัั
- Credentials ะดะปั KV **ะะ** ะฟะพะฒะธะฝะฝั ะผะฐัะธ ะฟัะตััะบั `NEXT_PUBLIC_` ะดะปั ะฑะตะทะฟะตะบะธ

### ะัะพะบ 3: ะะตัะตะทะฐะฟัััะธัะธ deployment

ะััะปั ะดะพะดะฐะฒะฐะฝะฝั environment variables:
1. ะะตัะตะนะดััั ะฒ **Deployments** โ ะฒะธะฑะตัััั ะพััะฐะฝะฝัะน deployment
2. ะะฐัะธัะฝััั **Retry deployment** ะฐะฑะพ ะทัะพะฑััั ะฝะพะฒะธะน commit

## ๐๏ธ ะฏะบ ัะต ะฟัะฐััั

### ะััััะตะบัััะฐ:

```
โโโโโโโโโโโโโโโ
โ   Browser   โ
โโโโโโโโฌโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Next.js Frontend       โ
โ  (Cloudflare Pages)     โ
โ                         โ
โ  โโโโโโโโโโโโโโโโโโโโ   โ
โ  โ  API Route       โ   โ โ Server-side (ะผะฐั ะดะพัััะฟ ะดะพ KV)
โ  โ  /api/agents     โ   โ
โ  โโโโโโโโโโฌโโโโโโโโโโ   โ
โ           โ             โ
โ           โผ             โ
โ  โโโโโโโโโโโโโโโโโโโโ   โ
โ  โ Cloudflare KV    โ   โ โ ะงะธัะฐั ะฝะฐะฟััะผั ัะตัะตะท REST API
โ  โ (Credentials)    โ   โ
โ  โโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะพะณัะบะฐ ัะพะฑะพัะธ:

1. **ะะฐะฒะฐะฝัะฐะถะตะฝะฝั ะฐะณะตะฝััะฒ:**
   - ะฏะบัะพ `NEXT_PUBLIC_USE_TUNNEL=true`, ััะพะฝัะตะฝะด ัะฟัะพะฑัั ะทะฐะฒะฐะฝัะฐะถะธัะธ ะฐะณะตะฝััะฒ ะท KV ัะตัะตะท `/api/agents`
   - ะฏะบัะพ ะฐะณะตะฝััะฒ ะฒ KV ะฝะตะผะฐั, ะทะฐะฒะฐะฝัะฐะถัั ะท localStorage
   - ะฏะบัะพ ั ะฒ localStorage ะฝะตะผะฐั, ััะฒะพััั ะดะตัะพะปัะฝะธะน ะฐะณะตะฝั

2. **ะััะธะผะฐะฝะฝั URL ััะฝะตะปั:**
   - ะคัะพะฝัะตะฝะด ะทะฐะฟะธััั `/api/agents?agentId=xxx` (server-side)
   - API route ัะธัะฐั ะท KV ั ะฟะพะฒะตััะฐั ะฟัะฑะปััะฝะธะน URL
   - ะัะฐัะทะตั ะพััะธะผัั ััะปัะบะธ URL (credentials ะทะฐะปะธัะฐััััั ะฝะฐ ัะตัะฒะตัั)

3. **ะะตะทะฟะตะบะฐ:**
   - Credentials (`CLOUDFLARE_*`) ะฒะธะบะพัะธััะพะฒัััััั ััะปัะบะธ ะฒ API routes (server-side)
   - ะัะฐัะทะตั ะะ ะผะฐั ะดะพัััะฟั ะดะพ credentials
   - ะัั ะทะฐะฟะธัะธ ะดะพ KV ะฒะธะบะพะฝัััััั ะฝะฐ ัะตัะฒะตัั

## ๐ ะะตัะตะฒััะบะฐ ะฝะฐะปะฐัััะฒะฐะฝะฝั

### 1. ะะตัะตะฒััะบะฐ API route

ะัะดะบัะธะนัะต ะฒ ะฑัะฐัะทะตัั:
```
https://your-domain.com/api/agents
```

ะะฐั ะฟะพะฒะตัะฝััะธ JSON ะทั ัะฟะธัะบะพะผ ะฐะณะตะฝััะฒ:
```json
{
  "ok": true,
  "agents": [
    {
      "id": "agent-hostname",
      "tunnelUrl": "https://xxx.trycloudflare.com",
      "updated_at": "2025-01-01T00:00:00.000Z"
    }
  ]
}
```

### 2. ะะตัะตะฒััะบะฐ ะบะพะฝะบัะตัะฝะพะณะพ ะฐะณะตะฝัะฐ

```
https://your-domain.com/api/agents?agentId=agent-hostname
```

ะะฐั ะฟะพะฒะตัะฝััะธ:
```json
{
  "ok": true,
  "url": "https://xxx.trycloudflare.com"
}
```

## ๐ ะะพะทะฒ'ัะทะฐะฝะฝั ะฟัะพะฑะปะตะผ

### ะัะพะฑะปะตะผะฐ: API route ะฟะพะฒะตััะฐั ะฟะพัะพะถะฝัะน ัะฟะธัะพะบ

**ะััะตะฝะฝั:**
1. ะะตัะตะฒัััะต, ัะพ environment variables ะฒััะฐะฝะพะฒะปะตะฝั ะฝะฐ Cloudflare Pages
2. ะะตัะตะฒัััะต, ัะพ API Token ะผะฐั ะฟัะฐะฒะฐ ะฝะฐ ัะธัะฐะฝะฝั KV
3. ะะตัะตะฒัััะต, ัะพ KV Namespace ID ะฟัะฐะฒะธะปัะฝะธะน
4. ะะตัะตะฒัััะต ะปะพะณะธ deployment ะฝะฐ Cloudflare

### ะัะพะฑะปะตะผะฐ: 401 Unauthorized

**ะััะตะฝะฝั:**
- ะะตัะตะฒัััะต ะฟัะฐะฒะธะปัะฝัััั `CLOUDFLARE_API_TOKEN`
- ะะตัะตะบะพะฝะฐะนัะตัั, ัะพ ัะพะบะตะฝ ะผะฐั ะฟัะฐะฒะฐ: **Workers KV Storage โ Edit**

### ะัะพะฑะปะตะผะฐ: ะะณะตะฝัะธ ะฝะต ะทะฐะฒะฐะฝัะฐะถัััััั

**ะััะตะฝะฝั:**
- ะะตัะตะฒัััะต, ัะพ `NEXT_PUBLIC_USE_TUNNEL=true`
- ะะตัะตะฒัััะต ะบะพะฝัะพะปั ะฑัะฐัะทะตัะฐ ะฝะฐ ะฟะพะผะธะปะบะธ
- ะะตัะตะฒัััะต, ัะพ ะฐะณะตะฝั ะทะฑะตััะณ ัะฒัะน URL ะฒ KV (ะดะธะฒััััั `agent/CLOUDFLARE_KV.md`)

## ๐ ะัะธะผััะบะธ

- API route `/api/agents` ะฟัะฐััั ััะปัะบะธ ะฝะฐ Cloudflare Pages (ัะตัะตะท server-side execution)
- ะะปั ะปะพะบะฐะปัะฝะพั ัะพะทัะพะฑะบะธ ะฟะพัััะฑะฝะพ ัะฐะบะพะถ ะดะพะดะฐัะธ credentials ะฒ `.env.local` (ะฑะตะท `NEXT_PUBLIC_`)
- Credentials ะฝะต ะฟะพััะฐะฟะปัััั ะฒ ะฑัะฐัะทะตั - ะฒะพะฝะธ ะฒะธะบะพัะธััะพะฒัััััั ััะปัะบะธ ะฝะฐ ัะตัะฒะตัั
- ะคัะพะฝัะตะฝะด ะฐะฒัะพะผะฐัะธัะฝะพ ะทะฐะฒะฐะฝัะฐะถัั ะฐะณะตะฝััะฒ ะท KV ะฟัะธ ะทะฐะฒะฐะฝัะฐะถะตะฝะฝั ััะพััะฝะบะธ

